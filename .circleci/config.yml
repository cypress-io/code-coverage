# https://circleci.com/docs/2.0/configuration-reference/
version: 2.1
orbs:
  # https://github.com/cypress-io/circleci-orb
  cypress: cypress-io/cypress@1.29.0 # used to run e2e tests
  win: circleci/windows@2 # run a test job on Windows

jobs:
  lint:
    description: Checks the code formatting
    docker:
      - image: cimg/node:16.9.1
        environment:
          # we don't need Cypress to check code styl
          CYPRESS_INSTALL_BINARY: '0'
    steps:
      - attach_workspace:
          at: ~/ 
      - run:
          name: Code style check ðŸ§¹
          command: npm run format:check
  publish:
    description: Publishes the new version of the plugin to NPM
    docker:
      - image: cimg/node:16.9.1
    environment:
      # we don't need Cypress to do the release
      CYPRESS_INSTALL_BINARY: '0'
      # trick semantic-release into thinking this is NOT a pull request
      # (under the hood the module env-ci is used to check if this is a PR)
      CIRCLE_PR_NUMBER: ''
      CIRCLE_PULL_REQUEST: ''
      CI_PULL_REQUEST: ''
    steps:
      - checkout
      - run: npm ci
      - run: npm run semantic-release

  test-code-coverage-plugin:
    docker:
      - image: cypress/base:16.13.2
    steps:
      - attach_workspace:
          at: ~/ 
      - run:
          command: npm run test
      - store_artifacts:
          path: coverage
      - run:
          name: Verify Code Coverage
          command: npm run coverage:verify

workflows:
  build:
    jobs:      

      - cypress/install:
          cache-key: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}'
          post-steps:
            - run: npm run check:markdown 

      - lint:
          requires:
            - cypress/install

      - test-code-coverage-plugin:
          requires:
            - cypress/install  
